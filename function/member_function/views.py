from django.shortcuts import render, get_object_or_404,redirect,reverse

from django.db.models import Q
from datetime import date
from function.member_function.models import GymMember, LoginRecord


# Create your views here.


from .forms import *
from django.contrib.auth import authenticate,login
from django.shortcuts import render,redirect


# for now()
import datetime


# for timezone()
import pytz

# paginator for our gym equipment
from django.core.paginator import Paginator
from django.contrib.auth.decorators import login_required
from django.shortcuts import render

    



#2/4/2025 updated
@login_required
def member_views(request):


    '''this is for view all member details'''

    #fetch data on models values that we needed
    members_list = GymMember.objects.values('id','id_card','expiry','first_name','last_name','gender','profile_image',)

    query_card = request.GET.get('id_card')
    #get filter the queary base on what we search
    if query_card:
        members_list =members_list.filter(Q(id_card__contains=query_card))

    paginator = Paginator(members_list,15)
    page_number = request.GET.get('page')
    members = paginator.get_page(page_number)
    # we use this line if we want to compare the details in GymMember
    today_date = date.today()

    context = {'members':members,
                'today_date':today_date}


    return render(request,'member/member_list.html',context)


@login_required
def member_update_views(request, member_id):
    member = get_object_or_404(GymMember, id=member_id)
    
    expiry_form = GymMembersUpdateFormsExpiry(instance=member)
    picture_form = GymMembersUpdateFormsPicture(instance=member)

    today_date = date.today()

    if request.method == 'POST':
        if 'expiry_submit' in request.POST:
            expiry_form =GymMembersUpdateFormsExpiry(request.POST,instance=member)
            if expiry_form.is_valid():
                expiry_form.save()
                return redirect('member_views')
        elif 'picture_submit' in request.POST:
            picture_form = GymMembersUpdateFormsPicture(request.POST,request.FILES,instance=member)
            if picture_form.is_valid():
                picture_form.save()
                return redirect('member_views')
            
    context = {
        'expiry_form':expiry_form,
        'picture_form':picture_form,
        'member':member,
        'today_date':today_date
    }

    return render(request, 'member/update_member.html', context)
    

@login_required
def member_login(request):
    if request.method == 'POST':
        id_card = request.POST.get('id_card')



        # using now() to get current time
        current_time_ph = datetime.datetime.now(pytz.timezone('Asia/Manila'))
        
        current_date_formated = current_time_ph.strftime('%Y-%m-%d')
        current_time_formated = current_time_ph.strftime('%H:%M:%S')

        today_date = date.today()

        try:
            #fetch the member provided by our id
            member = GymMember.objects.get(id_card=id_card)

            if LoginRecord.objects.filter(id_card=member.id_card,login_date=current_date_formated).exists():

                return render(request,'member/member_login.html',{
                    'error':f'ID card was already login this day {current_date_formated}',
                    'member':member
                })


            LoginRecord.objects.create(
                id_card=member.id_card,
                first_name=member.first_name,
                last_name=member.last_name,
                login_time = current_time_formated,
                login_date = current_date_formated
            )

            # Render a success template or return details
            return render(request, 'member/member_login.html', {
                'member': member,
                'today_date':today_date
            })
        except GymMember.DoesNotExist:
            # If the ID card is not found, return an error
            return render(request, 'member/member_login.html', {
                'error': 'Invalid ID Card. Please try again.'
            })
    return render(request, 'member/member_login.html')



@login_required
def login_record_views(request):
    '''show login record available here'''
    #we use values instead of all to limit the data we get here
    login_record = LoginRecord.objects.values('id_card','first_name','last_name','login_time','login_date')

    #get the queary card
    query_card = request.GET.get('id_card') 

    #get the queary card
    query_name = request.GET.get('query_name') 

    if query_card:
        login_record =  login_record.filter(Q(id_card__contains=query_card))
    
    #get query name search first name and last name
    if query_name:
        login_record = login_record.filter(Q(last_name__contains=query_name)|Q(first_name__contains=query_name))

    paginator = Paginator(login_record,5)
    page_number = request.GET.get('page')
    login_record_details = paginator.get_page(page_number)

    context = {

               'login_record_details':login_record_details,
               'id_card':query_card,
               'query_name':query_name

               }

    return render(request,'login_record.html',context)



@login_required
def member_register(request):
    if request.method == 'POST':
        form = MemberRegisterForm(request.POST,request.FILES)
        if form.is_valid():
            member = form.save()
            return redirect('member_register_successful_views',member_id=member.id)
        else:
            print(form.errors)
    else:
        form = MemberRegisterForm()

    context = {'form':form}

    return render(request,'member/member_register.html',context)


@login_required
def member_register_successful_views(request,member_id):
    member = GymMember.objects.get(id=member_id)
    context = {'member':member}
    return render(request,'member/member_register_successful.html',context)







































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































