from django.shortcuts import render, get_object_or_404,redirect,reverse
from django.http import HttpResponse
from django.db import connection
from datetime import date
from .models import GymMember,GymSale,LoginRecord,GymEquipment,SettingColorTable
# Create your views here.
from .forms import SettingColorForm,MemberRegisterForm , GymMembersUpdateFormsExpiry,GymMembersUpdateFormsPicture

# for now()
import datetime

# for timezone()
import pytz

# paginator for our gym equipment
from django.core.paginator import Paginator

def dash_board_views(request):
    """ count gender number"""

   
    # this will count the gender of our members  
    with connection.cursor() as cursor:
        cursor.execute('SELECT gender,COUNT(*)AS count FROM gym_members GROUP BY gender')
        results = cursor.fetchall()

    with connection.cursor() as cursor:
        cursor.execute('SELECT COUNT(ID_CARD) AS TOTAL FROM gym_members')
        results2 = cursor.fetchall()

    with connection.cursor() as cursor:
        cursor.execute('SELECT SUM(sale_price) FROM sale_table')
        results3 = cursor.fetchone()  # Add parentheses to fetchall()

    

    total_sales = results3[0] if results3 and results3[0] is not None else 0

    today = date.today().strftime("%Y-%m-%d") #display date today

    expired_members = GymMember .objects.filter(expiry__lt=today) # get the list of member expired
    count_expired = expired_members.count() # count the expired member

    
    print(count_expired)

    #count gender
    gender_count =[{'gender':row[0],'count':row[1]} for row in results]

    #count total_member
    total_member = [{'total_member': row[0]} for row in results2]  # Results now only contain total count.


    print(total_sales)
    
    
    

    context ={'gender_count':gender_count,
              'total_member':total_member,
              'today':today,
              'expired_members':expired_members,
              'count_expired':count_expired,
              'total_sales':total_sales
              }


    return render(request,'dashboard.html',context) 


def member_views(request):
    '''this is for view all member details'''

    #fetch data on models
    members = GymMember.objects.all()

    # we use this line if we want to compare the details in GymMember
    today_date = date.today()

    context = {'members':members,
                'today_date':today_date}


    return render(request,'member_list.html',context)



def member_update_views(request, member_id):
    member = get_object_or_404(GymMember, id=member_id)
    
    expiry_form = GymMembersUpdateFormsExpiry(instance=member)
    picture_form = GymMembersUpdateFormsPicture(instance=member)

    today_date = date.today()

    if request.method == 'POST':
        if 'expiry_submit' in request.POST:
            expiry_form =GymMembersUpdateFormsExpiry(request.POST,instance=member)
            if expiry_form.is_valid():
                expiry_form.save()
                return redirect('member_views')
        elif 'picture_submit' in request.POST:
            picture_form = GymMembersUpdateFormsPicture(request.POST,request.FILES,instance=member)
            if picture_form.is_valid():
                picture_form.save()
                return redirect('member_views')
            
    context = {
        'expiry_form':expiry_form,
        'picture_form':picture_form,
        'member':member,
        'today_date':today_date
    }

    return render(request, 'update_member.html', context)
    


def member_login(request):
    if request.method == 'POST':
        id_card = request.POST.get('id_card')



        # using now() to get current time
        current_time_ph = datetime.datetime.now(pytz.timezone('Asia/Manila'))
        
        current_date_formated = current_time_ph.strftime('%Y-%m-%d')
        current_time_formated = current_time_ph.strftime('%H:%M:%S')

        try:
            #fetch the member provided by our id
            member = GymMember.objects.get(id_card=id_card)

            if LoginRecord.objects.filter(id_card=member.id_card,login_date=current_date_formated).exists():

                return render(request,'member_login.html',{
                    'error':f'ID card was already login this day {current_date_formated}',
                    'member':member
                })


            LoginRecord.objects.create(
                id_card=member.id_card,
                first_name=member.first_name,
                last_name=member.last_name,
                login_time = current_time_formated,
                login_date = current_date_formated
            )

            # Render a success template or return details
            return render(request, 'member_login.html', {
                'member': member
            })
        except GymMember.DoesNotExist:
            # If the ID card is not found, return an error
            return render(request, 'member_login.html', {
                'error': 'Invalid ID Card. Please try again.'
            })
    return render(request, 'member_login.html')


def login_record_views(request):

    login_record = LoginRecord.objects.all()
    context = {'login_record':login_record}

    return render(request,'login_record.html',context)


def member_register(request):
    if request.method == 'POST':
        form = MemberRegisterForm(request.POST,request.FILES)
        if form.is_valid():
            form.save()
            return HttpResponse("created successfuly")
        else:
            print(form.errors)
    else:
        form = MemberRegisterForm()

    context = {'form':form}

    return render(request,'member_register.html',context)


def equipment_record_views(request):
    
    equipment_record = GymEquipment.objects.all()

    # it will only show first 8 in pagination
    paginator = Paginator(equipment_record,8)

    page_number =request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {'equipment_record':equipment_record,'page_obj':page_obj}


    return render(request,'gym_equipment_record.html',context)





def gym_sale_views(request):
    
    sale = GymSale.objects.all()
    context = {'sale':sale}

    return render(request,'sale_gym.html',context)



def background_color_form_views(request):
    # Default background color
    selected_color = SettingColorTable.objects.filter(active=1).first()

    if request.method == 'POST':
        form = SettingColorForm(request.POST)
        if form.is_valid():
            # Deactivate all current colors
            SettingColorTable.objects.all().update(active=0)

            # Get the selected color ID from the form
            selected_color = form.cleaned_data['color']

            # Retrieve the selected color object


            # Set the selected color as active and save it
            selected_color.active = 1
            selected_color.save()

            # Render the template with the updated color
            return render(request, 'color_background.html', {'form': form})
    else:
        # Pass the initial color to the form
        form = SettingColorForm(initial={'color':selected_color})

    return render(request, 'color_background.html', {'form': form})
























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































