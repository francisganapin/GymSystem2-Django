from django.shortcuts import render, get_object_or_404,redirect,reverse
from django.http import HttpResponse
from django.db import connection
from datetime import date
from .models import GymMember,GymSale,LoginRecord,GymEquipment
# Create your views here.
from .forms import MemberRegisterForm , GymMembersUpdateForms

# for now()
import datetime

# for timezone()
import pytz

# paginator for our gym equipment
from django.core.paginator import Paginator

def dash_board_views(request):
    """ count gender number"""

   
    # this will count the gender of our members  
    with connection.cursor() as cursor:
        cursor.execute('SELECT gender,COUNT(*)AS count FROM gym_members GROUP BY gender')
        results = cursor.fetchall()

    with connection.cursor() as cursor:
        cursor.execute('SELECT COUNT(ID_CARD) AS TOTAL FROM gym_members')
        results2 = cursor.fetchall()

    with connection.cursor() as cursor:
        cursor.execute('SELECT SUM(sale_price) FROM sale_table')
        results3 = cursor.fetchone()  # Add parentheses to fetchall()

    

    total_sales = results3[0] if results3 and results3[0] is not None else 0

    today = date.today().strftime("%Y-%m-%d") #display date today

    expired_members = GymMember .objects.filter(expiry__lt=today) # get the list of member expired
    count_expired = expired_members.count() # count the expired member

    
    print(count_expired)

    #count gender
    gender_count =[{'gender':row[0],'count':row[1]} for row in results]

    #count total_member
    total_member = [{'total_member': row[0]} for row in results2]  # Results now only contain total count.


    print(total_sales)
    
    
    

    context ={'gender_count':gender_count,
              'total_member':total_member,
              'today':today,
              'expired_members':expired_members,
              'count_expired':count_expired,
              'total_sales':total_sales
              }


    return render(request,'dashboard.html',context) 


def member_views(request):
    members = GymMember.objects.all()

    today_date = date.today()
    context = {'members':members,
                'today_date':today_date}


    return render(request,'member_list.html',context)



def member_update_views(request, member_id):
    member = get_object_or_404(GymMember, id=member_id)
    
    if request.method == 'POST':
        form = GymMembersUpdateForms(request.POST, request.FILES, instance=member)
        if form.is_valid():
            form.save()
            # Use reverse() to get the URL for member_views
            return redirect(('member_views'))  # Ensure 'member_views' is named correctly in urls.py
    else:
        form = GymMembersUpdateForms(instance=member)
    
    return render(request, 'update_member.html', {'form': form, 'member': member})
    


def member_login(request):
    if request.method == 'POST':
        id_card = request.POST.get('id_card')



        # using now() to get current time
        current_time_ph = datetime.datetime.now(pytz.timezone('Asia/Manila'))
        
        current_date_formated = current_time_ph.strftime('%Y-%m-%d')
        current_time_formated = current_time_ph.strftime('%H:%M:%S')

        try:
            #fetch the member provided by our id
            member = GymMember.objects.get(id_card=id_card)

            if LoginRecord.objects.filter(id_card=member.id_card,login_date=current_date_formated).exists():

                return render(request,'member_login.html',{
                    'error':f'ID card was already login this day {current_date_formated}',
                    'member':member
                })


            LoginRecord.objects.create(
                id_card=member.id_card,
                first_name=member.first_name,
                last_name=member.last_name,
                login_time = current_time_formated,
                login_date = current_date_formated
            )

            # Render a success template or return details
            return render(request, 'member_login.html', {
                'member': member
            })
        except GymMember.DoesNotExist:
            # If the ID card is not found, return an error
            return render(request, 'member_login.html', {
                'error': 'Invalid ID Card. Please try again.'
            })
    return render(request, 'member_login.html')


def login_record_views(request):

    login_record = LoginRecord.objects.all()
    context = {'login_record':login_record}

    return render(request,'login_record.html',context)


def member_register(request):
    if request.method == 'POST':
        form = MemberRegisterForm(request.POST,request.FILES)
        if form.is_valid():
            form.save()
            return HttpResponse("created successfuly")
        else:
            print(form.errors)
    else:
        form = MemberRegisterForm()

    context = {'form':form}

    return render(request,'member_register.html',context)


def equipment_record_views(request):
    
    equipment_record = GymEquipment.objects.all()
    paginator = Paginator(equipment_record,8)

    page_number =request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {'equipment_record':equipment_record,'page_obj':page_obj}


    return render(request,'gym_equipment_record.html',context)





def gym_sale_views(request):
    
    sale = GymSale.objects.all()
    context = {'sale':sale}

    return render(request,'sale_gym.html',context)

































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































